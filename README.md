<div align="center">

# AegisAV

### Autonomous Infrastructure Inspection with Explainable AI

[![Python 3.12+](https://img.shields.io/badge/Python-3.12+-3776AB?style=for-the-badge&logo=python&logoColor=white)](https://www.python.org/)
[![PydanticAI](https://img.shields.io/badge/Engine-PydanticAI-00ff9d?style=for-the-badge)](https://ai.pydantic.dev/)
[![ArduPilot](https://img.shields.io/badge/Flight-ArduPilot%20SITL-FFB800?style=for-the-badge)](https://ardupilot.org/)
[![Cosys-AirSim](https://img.shields.io/badge/Rendering-Cosys--AirSim%20%2B%20UE5.5-0E1128?style=for-the-badge)](https://cosys-lab.github.io/Cosys-AirSim/)
[![License MIT](https://img.shields.io/badge/License-MIT-green?style=for-the-badge)](LICENSE)

**AI-powered autonomous drone system for infrastructure monitoring**

[Quick Start](#-quick-start) | [Simulation](#-high-fidelity-simulation) | [Architecture](#-architecture) | [Vision System](#-vision-pipeline) | [Dashboard](#-dashboard)

</div>

---

## What is AegisAV?

**AegisAV** is an autonomous drone system designed for **infrastructure inspection** - solar farms, wind turbines, power lines, and electrical substations. It combines:

- **LLM-Powered Decision Making** - Goals are selected and prioritized by AI agents
- **Multi-Critic Safety Validation** - Every action is validated by safety, efficiency, and goal-alignment critics
- **Computer Vision Pipeline** - Defect detection with YOLO-based object detection
- **Rock-Solid Flight Control** - Built on ArduPilot, the same autopilot used in production drones
- **High-Fidelity Simulation** - Photorealistic rendering with Unreal Engine 5.5 + Cosys-AirSim

---

## Key Features


---

## Key Features

| Feature | Description |
|---------|-------------|
| **Autonomous Inspection** | AI selects which assets to inspect based on priority and conditions |
| **Defect Detection** | Computer vision identifies cracks, corrosion, hot spots, and damage |
| **Explainable AI** | Every decision includes human-readable reasoning and risk assessment |
| **Multi-Agent Critics** | 3-layer safety validation (Safety, Efficiency, Goal) for every action |
| **Cost Awareness** | Real-time LLM token tracking and budget enforcement |
| **Edge Intelligence** | Configurable policies for bandwidth management and anomaly gating |
| **Risk Evaluation** | **[NEW]** Framework to quantify mission risk based on battery, weather, and GPS factors |
| **Behavioral Validation** | **[NEW]** Integration tests ensuring correct multi-drone decision logic in complex scenarios |
| **Strict Type Safety** | **[NEW]** Full type annotations on all functions with mypy enforcement |
| **Code Quality** | **[NEW]** Pre-commit hooks with ruff, mypy, pylint, and gitleaks |
| **Real-Time Dashboard** | Monitor vehicle state, detections, and AI reasoning live |
| **Production Flight Controller** | Uses ArduPilot SITL - same code that runs on real Pixhawk hardware |
| **Photorealistic Simulation** | Unreal Engine 5.5 rendering with Cosys-AirSim physics |

---

## Quick Start

### Option 1: Vision Demo (No External Dependencies)

```bash
# Clone and setup
git clone https://github.com/pjdog/AegisAV.git && cd AegisAV
uv sync

# Run the integrated demo (uses development config by default)
uv run python examples/demo_integrated_vision.py
```

This generates a visual report with annotated images and a timeline:
- Output directory: `data/vision/demo_visual/`
- HTML report: `data/vision/demo_visual/reports/demo_report.html`

Open the HTML report in your browser to view the demo.

### Option 2: Lightweight Simulation (Laptop-Friendly)

Run the lightweight simulator server and built-in visualizer:

```bash
uv run python -m simulation.lightweight.server
```

- Visualizer: `http://localhost:8081/viz/`
- API docs: `http://localhost:8081/docs`

Optional: run the agent server alongside it:

```bash
uv run python -m agent.server.main
```

Note: live decision wiring is still in progress. See
`docs/INTEGRATION_STATUS.md` for current gaps.

### Option 3: Full Simulation (Recommended)

1. **Setup Simulation**: Follow the [Simulation Setup](#-high-fidelity-simulation) guide.
2. **Configure**: Copy `configs/aegis_config.development.yaml` to `configs/aegis_config.yaml`.
3. **Run**:

```bash
# Terminal 1: Start Unreal/Cosys-AirSim (see verification guide)
# Terminal 2: Start ArduPilot SITL
# Terminal 3: Run AegisAV
uv run python simulation/run_simulation.py --airsim --sitl
```

On Windows, you can launch Cosys-AirSim with `start_airsim.bat` (generated by the installer).

If the overlay is blank or nothing is moving, see `docs/OVERLAY_TROUBLESHOOTING.md`.

---

## Architecture

```
┌───────────────────────────────────────────────────────────────────┐
│                       DECISION LAYER                               │
│                  (Agent Server - PydanticAI)                       │
│   ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐   │
│   │ World Model │  │Goal Selector│  │    Multi-Critic         │   │
│   │  (Assets,   │  │    (LLM)    │  │ Safety│Efficiency│Goal  │   │
│   │  Vehicle)   │  │             │  │ Critic│  Critic  │Align │   │
│   └─────────────┘  └─────────────┘  └─────────────────────────┘   │
└───────────────────────────────────────────────────────────────────┘
         │                   │                      │
         ▼                   ▼                      ▼
┌───────────────────────────────────────────────────────────────────┐
│                       VISION LAYER                                 │
│   ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐   │
│   │   Camera    │  │    YOLO     │  │    Anomaly Detection    │   │
│   │   Capture   │→ │  Detector   │→ │   & Classification      │   │
│   └─────────────┘  └─────────────┘  └─────────────────────────┘   │
└───────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌───────────────────────────────────────────────────────────────────┐
│                      EXECUTION LAYER                               │
│   ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐   │
│   │   Action    │  │    State    │  │   Edge Policy Engine    │   │
│   │  Executor   │  │  Collector  │  │  (Bandwidth/Gating)     │   │
│   └─────────────┘  └─────────────┘  └─────────────────────────┘   │
└───────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌───────────────────────────────────────────────────────────────────┐
│                      CONTROL LAYER                                 │
│                (ArduPilot SITL / Pixhawk Hardware)                │
│            Stabilization • Navigation • Sensor Fusion             │
│                        (MAVLink)                                  │
└───────────────────────────────────────────────────────────────────┘
```

---

## Configuration & Edge Policy

AegisAV features a unified configuration system (`ConfigManager`) supporting:
- **YAML Configs**: `configs/aegis_config.yaml` (overrides defaults)
- **Environment Variables**: `AEGIS_VISION_ENABLED=true`
- **Runtime Updates**: Change settings via Dashboard UI or API

### Edge Computing Policies
Optimize bandwidth and processing by configuring the client's behavior:
- **Anomaly Gating**: Only transmit images when defects exceed specific confidence/severity thresholds.
- **Capture Cadence**: Dynamically adjust frame rates based on mission phase.
- **Cost Budgeting**: LLM calls are tracked and capped daily (default $1.00/day).

### Persistence (Redis)
Enable Redis for persistent telemetry, detections, anomalies, and mission data:
- Config: `configs/aegis_config.yaml` -> `redis.enabled: true`
- Env: `AEGIS_REDIS_ENABLED=true`, `AEGIS_REDIS_HOST`, `AEGIS_REDIS_PORT`
- Docker: `docker compose up --build` starts Redis automatically.

### Authentication (API Key)
Enable API key authentication for protected endpoints:
- Config: `auth.enabled: true`, `auth.api_key: <key>`
- Env: `AEGIS_API_KEY=<key>`
- Header: `X-API-Key: <key>`

The current dashboard does not send API keys. Keep auth disabled for UI use,
or front it with a proxy that injects the header. See
`docs/INTEGRATION_STATUS.md`.

---

## Vision Pipeline

The vision system detects infrastructure defects in real-time:

### Supported Defect Types

| Category | Defects Detected |
|----------|------------------|
| **Solar Panels** | Cracks, hot spots, debris, soiling, cell damage |
| **Wind Turbines** | Blade erosion, lightning damage, ice accumulation |
| **Power Lines** | Damaged conductors, vegetation encroachment, insulator damage |
| **Substations** | Corrosion, oil leaks, thermal anomalies |

---

## Dashboard

The Aegis Onyx Dashboard provides real-time monitoring and configuration:

| Panel | Description |
|-------|-------------|
| **Vehicle State** | Position, altitude, battery, flight mode |
| **Radar View** | Spatial visualization of vehicle and assets |
| **Reasoning Feed** | Live AI decision explanations and critic feedback |
| **Settings** | **[NEW]** Runtime configuration of thresholds and policies |
| **Mission Status** | Current goal and progress |

Access at:
- `http://localhost:8080/dashboard` (default server)
- `http://localhost:8000/dashboard` (when using `simulation/run_simulation.py`)

## Logs & Observability

- Agent server (dashboard log feed): `GET /api/logs`
- Decision logs: `logs/decisions_<run_id>.jsonl`
- Telemetry logs: `logs/telemetry_<run_id>.jsonl`
- Outcome logs: `logs/outcomes/outcomes_<run_id>.jsonl`
- Lightweight sim log aggregation: `GET /api/logs` and `/api/logs/sources`
  on the lightweight server (see Option 2).

---

## Project Structure

```
AegisAV/
├── agent/
│   ├── server/              # Decision layer
│   │   ├── content/         # ConfigManager and settings
│   │   ├── critics/         # Multi-agent validation system
│   │   ├── monitoring/      # Cost tracking, outcome logging
│   │   └── vision/          # Vision service integration
│   └── client/              # Execution layer & edge policies
├── autonomy/                # Vehicle interface (MAVLink)
├── vision/                  # Computer vision pipeline
├── simulation/              # High-fidelity simulation
├── frontend/                # Aegis Onyx dashboard (Vite + React)
├── configs/                 # Configuration templates
└── tests/                   # Comprehensive test suite (150+ tests)
```

---

## Development

### Prerequisites

- **Python 3.12+**
- **uv** - `curl -LsSf https://astral.sh/uv/install.sh | sh`
- **Node.js 18+** - For dashboard development

### Install & Build

```bash
# Sync Python environment
uv sync

# Build dashboard
cd frontend && npm install && npm run build && cd ..
```

### Code Quality

AegisAV enforces strict code quality via pre-commit hooks:

```bash
# Install pre-commit hooks
pre-commit install

# Run manually
pre-commit run --all-files
```

**Enforced Standards:**
- **Type Safety**: All functions have type annotations (ruff ANN rules + mypy)
- **Documentation**: Google-style docstrings (ruff D rules)
- **Security**: Bandit security scanning + gitleaks secret detection
- **Style**: Consistent formatting with ruff

### Run Tests

```bash
# Full test suite
uv run pytest

# With coverage
uv run pytest --cov=agent --cov=autonomy --cov=vision

# Specific modules
uv run pytest tests/test_config_manager.py -v
```

---

## Roadmap

See [plan.md](plan.md) for the detailed project roadmap.

## Integration Status

See `docs/INTEGRATION_STATUS.md` for wiring gaps and pending connections.

- [x] **Phase 1**: Foundation (Architecture, Simulation, Vision)
- [x] **Phase 2**: Multi-Agent Validation (Critics, Safety, Integration)
- [ ] **Phase 3**: Intelligence & Production (Optimization, Learning)
    - [x] System Configuration & UI
    - [x] Edge Policies & Cost Tracking
    - [x] Risk Evaluation & Behavioral Tests
    - [x] Full Type Safety & Code Quality Enforcement
    - [ ] Hybrid LLM Decision Engine
    - [ ] Advanced Explanation Agent

---

## License

**MIT License** - Free for research, education, and development.

> **Disclaimer**: This software is for simulation and research only. Not certified for actual flight operations.

---

<div align="center">

Built for the future of autonomous infrastructure monitoring.

</div>
